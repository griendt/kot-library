<?php

namespace App\Http\Controllers;

use App\Trap;
use App\LayoutExploit as LayoutExploitModel;
use Illuminate\Http\Request;
use Auth;

class LayoutExploit extends Controller
{

    public function delete(Request $request) {
        if (!Auth::user()) {
            return redirect()->back()->withInput()->with('fail', 'You are not authorised to delete this exploit!');
        }
        else {
            $exploit =  LayoutExploitModel::whereId($request->input('layout_exploit_id'))->first();
            if (!$exploit) {
                return redirect()->back()->withInput()->with('fail', 'Exploit could not be found!');
            }
            $video = public_path($exploit->exploit_video);
            $exploit->delete();
            \File::delete($video);

            return redirect()->back()->withInput()->with('success', 'Exploit was successfully deleted.');
        }
    }

    public function store(Request $request) {

        $validator = $request->validate([
            'base_identifier' => 'required|integer', // Hidden in form
            'trap1' => 'nullable|string',
            'trap2' => 'nullable|string',
            'trap3' => 'nullable|string',
            'layout_screenshot' => 'required|image',
            'exploit_video' => 'required|file',
            'comment' => 'string|nullable',
        ]);
        $exceptions = [];
        $videoName = '';
        $screenshotName = '';

        if ($request->hasFile('exploit_video')) {
            try {
                $file = $request->file('exploit_video');
                $videoName = 'exploit_' . Auth::user()->username . '_' . date('Y-m-dHis_v') . '_video.' . $file->getClientOriginalExtension();
                $request->file('exploit_video')->move(public_path('storage/exploits'), $videoName);
            }
            catch (\Exception $error) {
                $exceptions[] = $error;
            }
        }
        if ($request->hasFile('layout_screenshot')) {
            try {
                $file = $request->file('layout_screenshot');
                $screenshotName = 'exploit_' . Auth::user()->username . '_' . date('Y-m-dHis_v') . '_screenshot.' . $file->getClientOriginalExtension();
                $request->file('layout_screenshot')->move(public_path('storage/exploits'), $screenshotName);
            }
            catch (\Exception $error) {
                $exceptions[] = $error;
            }
        }

        if (empty($exceptions)) {
            $trapNames = [
                'trap1' => str_replace('_', ' ', title_case($request->input('trap1'))),
                'trap2' => str_replace('_', ' ', title_case($request->input('trap2'))),
                'trap3' => str_replace('_', ' ', title_case($request->input('trap3')))
            ];

            LayoutExploitModel::create([
                'base_identifier' => $request->input('base_identifier'),
                'trap_1_identifier' => $trapNames['trap1'] == '-' ? null : Trap::whereName($trapNames['trap1'])->first()->identifier,
                'trap_2_identifier' => $trapNames['trap2'] == '-' ? null : Trap::whereName($trapNames['trap2'])->first()->identifier,
                'trap_3_identifier' => $trapNames['trap3'] == '-' ? null : Trap::whereName($trapNames['trap3'])->first()->identifier,
                'layout_screenshot' => 'storage/exploits/' . $screenshotName,
                'exploit_video' => 'storage/exploits/' . $videoName,
                'exploit_comment' => $request->input('exploit_comment')
            ]);
        }

        return redirect()->back()->withInput()->with('success', 'File uploaded successfully!');
    }

}
