<?php

namespace App\Http\Controllers;

use App\Trap;
use App\LayoutExploit as LayoutExploitModel;
use Illuminate\Http\Request;
use Auth;

class LayoutExploit extends Controller
{

    /**
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function delete(Request $request) {
        if (!Auth::user()) {
            return redirect()->back()->withInput()->with('fail', 'You are not authorised to delete this exploit!');
        }
        else {
            $exploit =  LayoutExploitModel::whereId($request->input('layout_exploit_id'))->first();
            if (!$exploit) {
                return redirect()->back()->withInput()->with('fail', "Exploit with id {$request->input('layout_exploit_id')} could not be found!");
            }
            $video = public_path($exploit->exploit_video);
            $exploit->delete();
            \File::delete($video);

            return redirect()->back()->withInput()->with('success', 'Exploit was successfully deleted.');
        }
    }

    public function store(Request $request) {
        $validator = $request->validate([
            'base_identifier' => 'required|integer', // Hidden in form
            'trap1' => 'nullable|string',
            'trap2' => 'nullable|string',
            'trap3' => 'nullable|string',
            'layout_screenshot' => 'required|image',
            'exploit_video' => 'nullable|file',
            'exploit_you_tube' => 'nullable|string',
            'comment' => 'string|nullable',
        ]);

        if (is_null($request->input('exploit_you_tube')) && !$request->hasFile('exploit_video')) {
            return redirect()->back()->with('fail', 'No video nor YouTube link supplied!');
        }
        if (!$request->hasFile('exploit_video') && strpos($request->input('exploit_you_tube'), 'youtube') === false && strpos($request->input('exploit_you_tube'), 'youtu.be') === false) {
            return redirect()->back()->with('fail', 'Link provided was not a YouTube link!');
        }

        $exceptions = [];
        $videoName = '';
        $screenshotName = '';

        $videoIsYouTube = false;

        if ($request->hasFile('exploit_video') && is_null($request->input('exploit_you_tube'))) {
            try {
                $file = $request->file('exploit_video');
                $videoName = 'exploit_' . Auth::user()->username . '_' . date('Y-m-dHis_v') . '_video.' . $file->getClientOriginalExtension();
                $request->file('exploit_video')->move(public_path('storage/exploits'), $videoName);
            }
            catch (\Exception $error) {
                $exceptions[] = $error;
            }
        }
        elseif (!empty($request->input('exploit_you_tube'))) {
            $videoName = $request->input('exploit_you_tube');
            if (strpos($videoName, '://') === false) {
                $videoName = "https://" . $videoName;
            }
            $videoIsYouTube = true;
        }

        if ($request->hasFile('layout_screenshot')) {
            try {
                $file = $request->file('layout_screenshot');
                $screenshotName = 'exploit_' . Auth::user()->username . '_' . date('Y-m-dHis_v') . '_screenshot.' . $file->getClientOriginalExtension();
                $request->file('layout_screenshot')->move(public_path('storage/exploits'), $screenshotName);
            }
            catch (\Exception $error) {
                $exceptions[] = $error;
            }
        }

        if (empty($exceptions)) {
            $trapNames = [
                'trap1' => str_replace('_', ' ', title_case($request->input('trap1'))),
                'trap2' => str_replace('_', ' ', title_case($request->input('trap2'))),
                'trap3' => str_replace('_', ' ', title_case($request->input('trap3')))
            ];

            LayoutExploitModel::create([
                'base_identifier' => $request->input('base_identifier'),
                'trap_1_identifier' => $trapNames['trap1'] == '-' ? null : Trap::whereName($trapNames['trap1'])->first()->identifier,
                'trap_2_identifier' => $trapNames['trap2'] == '-' ? null : Trap::whereName($trapNames['trap2'])->first()->identifier,
                'trap_3_identifier' => $trapNames['trap3'] == '-' ? null : Trap::whereName($trapNames['trap3'])->first()->identifier,
                'layout_screenshot' => 'storage/exploits/' . $screenshotName,
                'exploit_video' => $videoIsYouTube ? $videoName : 'storage/exploits/' . $videoName,
                'exploit_comment' => $request->input('exploit_comment'),
                'uploader_user_name' => Auth::user()->username,
            ]);
        }

        return redirect()->back()->withInput()->with('success', 'File uploaded successfully!');
    }

}
